{
  "entities": {
    "PlayerProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PlayerProfile",
      "type": "object",
      "description": "Represents a volleyball player's profile, including their personal information, athletic details, and target schools.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the player profile."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 PlayerProfile)"
        },
        "name": {
          "type": "string",
          "description": "The player's full name."
        },
        "position": {
          "type": "string",
          "description": "The player's primary volleyball position."
        },
        "height": {
          "type": "string",
          "description": "The player's height."
        },
        "gradYear": {
          "type": "string",
          "description": "The player's high school graduation year."
        },
        "targetLevel": {
          "type": "string",
          "description": "The player's target level of play (e.g., D1, D2, D3)."
        },
        "preferredSchools": {
          "type": "string",
          "description": "A comma-separated string of the player's preferred schools."
        },
        "highlightVideoUrl": {
          "type": "string",
          "description": "URL to the player's highlight video."
        },
        "profilePictureUrl": {
          "type": "string",
          "description": "URL to the player's profile picture."
        },
        "coachFeedbackIds": {
          "type": "array",
          "description": "References to CoachFeedback. (Relationship: CoachFeedback 1:N PlayerProfile)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "position",
        "height",
        "gradYear",
        "targetLevel",
        "preferredSchools",
        "highlightVideoUrl"
      ]
    },
    "CoachFeedback": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CoachFeedback",
      "type": "object",
      "description": "Represents feedback provided by a coach on a player profile.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the feedback entry."
        },
        "coachId": {
          "type": "string",
          "description": "Reference to Coach. (Relationship: Coach 1:N CoachFeedback)"
        },
        "playerId": {
          "type": "string",
          "description": "Reference to PlayerProfile. (Relationship: PlayerProfile 1:N CoachFeedback)"
        },
        "feedback": {
          "type": "string",
          "description": "The coach's feedback text."
        },
        "date": {
          "type": "string",
          "description": "The date and time the feedback was provided.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "coachId",
        "playerId",
        "feedback",
        "date"
      ]
    },
    "Coach": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Coach",
      "type": "object",
      "description": "Represents a coach who can provide feedback on player profiles.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the coach."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 Coach)"
        },
        "name": {
          "type": "string",
          "description": "The coach's full name."
        },
        "email": {
          "type": "string",
          "description": "The coach's email address.",
          "format": "email"
        },
        "affiliation": {
          "type": "string",
          "description": "The coach's school or club affiliation."
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "email"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application. Note: Authentication information (e.g., password) is not stored here.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The user's role (e.g., player, coach)."
        }
      },
      "required": [
        "id",
        "email",
        "role"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user information, including email and role. Key for role-based access control. Path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/playerProfiles/{playerProfileId}",
        "definition": {
          "entityName": "PlayerProfile",
          "schema": {
            "$ref": "#/backend/entities/PlayerProfile"
          },
          "description": "Stores player profile data. Includes denormalized 'userId' field for authorization independence. Allows players to manage their profiles.",
          "params": [
            {
              "name": "playerProfileId",
              "description": "The unique identifier for the player profile."
            }
          ]
        }
      },
      {
        "path": "/coaches/{coachId}",
        "definition": {
          "entityName": "Coach",
          "schema": {
            "$ref": "#/backend/entities/Coach"
          },
          "description": "Stores coach information, including name, email, and affiliation. Coaches can review assigned player profiles and provide feedback.",
          "params": [
            {
              "name": "coachId",
              "description": "The unique identifier for the coach."
            }
          ]
        }
      },
      {
        "path": "/coachFeedback/{coachFeedbackId}",
        "definition": {
          "entityName": "CoachFeedback",
          "schema": {
            "$ref": "#/backend/entities/CoachFeedback"
          },
          "description": "Stores coach feedback on player profiles. Includes 'playerId' and 'coachId' for authorization and linking feedback to players. Coaches provide assessments tailored to player's target level.",
          "params": [
            {
              "name": "coachFeedbackId",
              "description": "The unique identifier for the coach feedback entry."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide secure and efficient data access for the CourtConnect application, focusing on player profiles and coach feedback. The key principle is Authorization Independence, achieved through denormalization. This eliminates the need for `get()` calls in security rules, ensuring atomic operations and easier debugging.\n\nThe structure includes:\n\n*   `/users/{userId}`: Stores user information, including roles. This collection enables role-based access control.\n*   `/playerProfiles/{playerProfileId}`: Stores player profile data. The `userId` field is denormalized to enable simple security rules that check if `request.auth.uid == resource.data.userId`.\n*   `/coaches/{coachId}`: Stores coach information, including a reference to their user ID.\n*   `/coachFeedback/{coachFeedbackId}`: Stores coach feedback. Includes `playerId` to link feedback to players and `coachId` to link feedback to coaches.\n\n**Authorization Independence (Denormalization):**\n\n*   The `playerProfiles` collection includes the `userId` field, which is a denormalization of the user's ID. This allows security rules to validate ownership without performing additional reads.  Security rules can directly check if the authenticated user ID matches the `userId` field in the profile.\n*   `CoachFeedback` stores both `playerId` and `coachId`, enabling direct validation of write access based on user roles and entity ownership without complex lookups.\n\n**QAPs (Rules are not Filters):**\n\n*   The segregation of data into distinct collections (`users`, `playerProfiles`, `coaches`, `coachFeedback`) allows for simplified security rules tailored to each data type.  Each collection enforces its own access control policies.\n*   Path-based ownership (`/users/{userId}/...`) ensures that list operations are secure by default. For example, listing player profiles is restricted to the authenticated user if they are the owner of the profiles.  Coach feedback can only be written by the coach identified in the `coachId` field.\n\n**Other Considerations:**\n\n*   The structure facilitates role-based access control (DBAC) by storing roles within the `/users/{userId}` document. This eliminates the need for custom claims.\n*   Consistent naming conventions (e.g., `userId`, `coachId`) and explicit relationships between entities enhance clarity and maintainability."
  }
}
