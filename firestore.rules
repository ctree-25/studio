
/**
 * # Firestore Security Rules for CourtConnect
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership and role-based model. Users have full control over their own data (like their profile), while interactions between different user types (like a coach giving feedback to a player) are governed by specific authorization checks. The primary goal is to ensure data privacy and integrity while allowing for public discovery of profiles.
 *
 * ## Data Structure
 * The data is organized into four top-level collections: `/users`, `/playerProfiles`, `/coaches`, and `/assessments`. This flat structure simplifies rules by avoiding complex path traversals.
 *
 * ## Key Security Decisions
 * - **Profile Visibility**: Player and Coach profiles (`/playerProfiles`, `/coaches`) are publicly readable to allow for discovery within the app. However, write access is strictly limited to the profile owner.
 * - **Assessment Creation**: Only authenticated coaches can create new assessments.
 * - **Assessment Visibility**: An assessment can only be read by the player it belongs to, or the coach who wrote it.
 * - **Default Deny**: Any access not explicitly granted by these rules is denied.
 *
 * ## Denormalization for Authorization
 * To create simpler and more performant rules, this ruleset relies on denormalized data. For example, the `/playerProfiles/{profileId}` document contains a `userId` field, allowing rules to verify ownership directly (`resource.data.userId == request.auth.uid`) without performing a costly `get()`.
 *
 * ## Structural Segregation
 * Data is logically separated into distinct top-level collections based on its purpose and access patterns (e.g., public profiles vs. private data). This is more secure and performant than mixing public and private data in a single collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * isSignedIn
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * isOwner
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * isCoach
     * Verifies that the requesting user has the 'coach' role in their user document.
     * This is a critical function for role-based access control.
     */
    function isCoach() {
      // Use exists() to check for the document before accessing its data.
      // This is more secure and prevents errors if the document doesn't exist.
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach';
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user account data. A user can create their own document
     *   and can only ever read or update their own data. The role cannot be changed
     *   after creation.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User privacy: explicitly disallow listing all users.
      // A user can create their own user document, ensuring the UID in the path matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role; // Prevent role change
      allow delete: if false; // Users should not delete their role document.
    }

    /**
     * @description Player profiles are public for anyone to view but can only
     *   be created, updated, or deleted by the player who owns the profile.
     * @path /playerProfiles/{playerProfileId}
     */
    match /playerProfiles/{playerProfileId} {
      allow get, list: if true;
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);
    }

    /**
     * @description Coach profiles are public for anyone to view but can only
     *   be created, updated, or deleted by the coach who owns the profile.
     * @path /coaches/{coachId}
     */
    match /coaches/{coachId} {
      allow get, list: if true;
      allow create, update, delete: if isCoach() && isOwner(request.resource.data.userId);
    }

    /**
     * @description Stores individual assessments from coaches.
     * @path /assessments/{assessmentId}
     */
    match /assessments/{assessmentId} {
        // Only an authenticated coach can create an assessment.
        // The coachId in the document must match their own UID.
        allow create: if isCoach() && request.resource.data.coachId == request.auth.uid;

        // An assessment can be read by the player it belongs to, or the coach who wrote it.
        allow get: if isSignedIn() &&
            (request.auth.uid == resource.data.playerId || request.auth.uid == resource.data.coachId);
        
        // A player or coach can list only their own assessments.
        // This is enforced by client-side queries and backed by the `get` rule.
        allow list: if isSignedIn();

        // Updates and deletes are disallowed to maintain a clear audit trail.
        allow update, delete: if false;
    }
  }
}
