
/**
 * # Firestore Security Rules for CourtConnect
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership and role-based model. Users have full control over their own data (like their profile), while interactions between different user types (like a coach giving feedback to a player) are governed by specific authorization checks. The primary goal is to ensure data privacy and integrity while allowing for public discovery of profiles.
 *
 * ## Data Structure
 * The data is organized into four top-level collections: `/users`, `/playerProfiles`, `/coaches`, and `/assessments`. This structure simplifies rules by tying data directly to its ownership and access context.
 *
 * ## Key Security Decisions
 * - **Profile Visibility**: Player and Coach profiles (`/playerProfiles`, `/coaches`) are publicly readable to allow for discovery within the app. However, write access is strictly limited to the profile owner.
 * - **Assessment Creation**: Only a verified coach can create an assessment document. The document must correctly list their own UID as the coachId.
 * - **Assessment Visibility**: An assessment can only be read by the player it belongs to, or the coach who wrote it.
 * - **Default Deny**: Any access not explicitly granted by these rules is denied.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * isSignedIn
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * isOwner
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * isCoach
     * Verifies that the requesting user has the 'coach' role in their user document.
     * This is a critical function for role-based access control.
     */
    function isCoach() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach';
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user account data. A user can create their own document
     *   and can only ever read or update their own data. The role cannot be changed
     *   after creation.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isSignedIn(); // Allow any signed-in user to read role docs, crucial for rule validation.
      allow list: if false; // User privacy: explicitly disallow listing all users.
      // A user can create their own user document, ensuring the UID in the path matches their auth UID.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role; // Prevent role change
      allow delete: if false; // Users should not delete their role document.
    }

    /**
     * @description Player profiles are public for anyone to view but can only
     *   be created, updated, or deleted by the player who owns the profile.
     * @path /playerProfiles/{playerProfileId}
     */
    match /playerProfiles/{playerProfileId} {
      allow get, list: if true;
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);
    }

    /**
     * @description Coach profiles are public for anyone to view but can only
     *   be created or updated by the coach who owns the profile.
     * @path /coaches/{coachId}
     */
    match /coaches/{coachId} {
      allow get, list: if true;
      allow create: if isCoach() && isOwner(request.resource.data.userId);
      allow update, delete: if isCoach() && isOwner(resource.data.userId);
    }

    /**
     * @description Stores individual assessments.
     * @path /assessments/{assessmentId}
     */
    match /assessments/{assessmentId} {
      // A coach can only create an assessment and must be the author.
      allow create: if isCoach() && request.auth.uid == request.resource.data.coachId;
      
      // An assessment can be read by the player it belongs to, or the coach who wrote it.
      allow get: if isSignedIn() && (request.auth.uid == resource.data.playerId || request.auth.uid == resource.data.coachId);

      // A user can list assessments ONLY if their query filters for assessments where
      // they are the player OR the coach. This rule works in conjunction with client-side queries.
      // It is intentionally broad on the rule side to allow for different client queries,
      // but secure because the client queries MUST filter by an ID that matches the user's UID.
      allow list: if isSignedIn();

      // Updates and deletes are disallowed to maintain an audit trail.
      allow update, delete: if false;
    }
  }
}
